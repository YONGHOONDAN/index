<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>위치 마커 & 메모 — PWA v3 (맛집 검색 추가)</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="마커 & 메모" />
<meta name="theme-color" content="#1e90ff" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
:root { --header-h: 56px; }
html,body { height: 100%; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial, sans-serif; }
header { position: fixed; top: 0; left: 0; right: 0; background: #1e90ff; color: #fff; display:flex; flex-wrap:wrap; gap:6px; padding:6px; z-index:1000; }
header strong { font-size:16px; white-space:nowrap; }
header button { padding:8px 10px; font-size:14px; border-radius:6px; border:0; }
#map { position: absolute; top: var(--header-h); bottom: 0; left:0; right:0; }
#markerList { position: absolute; right: 8px; top: calc(var(--header-h) + 8px); width: 280px; max-height: 60vh; overflow:auto; background: rgba(255,255,255,0.98); padding:8px; border-radius:8px; z-index:1000; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
.m-item { padding:10px; border-bottom:1px solid #eee; }
.m-item small { color:#666; display:block; margin-top:6px; }
.btn-sm { padding:6px 8px; font-size:13px; margin-left:6px; border-radius:8px; }
textarea { width:100%; height:90px; font-family:inherit; border-radius:6px; padding:8px; }
#warn { position: fixed; bottom: 8px; left: 8px; right: 8px; background:#fff3cd; color:#664d03; border:1px solid #ffec99; border-radius:8px; padding:10px; display:none; z-index:1001; }
.fab { position: fixed; right: 14px; width: 54px; height: 54px; border-radius: 50%; border:0; box-shadow: 0 6px 16px rgba(0,0,0,0.25); background:#1e90ff; color:#fff; font-size:22px; z-index:1002; }
#fab-add { bottom: 20px; }
#fab-loc { bottom: 84px; }
  #nearbyPanel { position:absolute; left:8px; top: calc(var(--header-h) + 8px); right:8px; max-height:60vh; overflow:auto; background:#fff; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.2); padding:10px; z-index:1100; display:none; }
  .nearby-header { display:flex; justify-content:space-between; align-items:center; gap:8px; position:sticky; top:0; background:#fff; padding-bottom:6px; border-bottom:1px solid #eee; }
  .nearby-list { margin:8px 0; display:grid; grid-template-columns:1fr; gap:8px; }
  .nearby-item { border:1px solid #eee; border-radius:8px; padding:8px; }
  .nearby-item b { display:block; margin-bottom:4px; }
  .nearby-actions { display:flex; gap:6px; flex-wrap:wrap; }
  .pill { display:inline-block; padding:4px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
  .nearby-empty { color:#666; font-size:14px; }
</style>
</head>
<body>
<header>
<strong>위치 마커 & 메모</strong>
<button id="locBtn">현재 위치로 이동</button>
<button id="markHereBtn">현재 위치에 마커</button>
<button id="addCenterBtn">현재 중심에 마커</button>
<button id="toggleListBtn">마커 목록</button>
<button id="nearbyBtn">주변 맛집</button>
<button id="exportBtn">내보내기</button>
<button id="importBtn">가져오기</button>
<input id="importFile" type="file" accept="application/json" style="display:none">
<button id="clearBtn">모두 삭제</button>
<button id="findFoodBtn">주변 맛집 검색</button>
</header>
<div id="map"></div>
<div id="markerList" style="display:none"></div>
<div id="warn"></div>
<div id="nearbyPanel">
  <div class="nearby-header">
    <div>
      <strong>주변 맛집</strong>
      <span id="nearbyWhere" class="pill"></span>
    </div>
    <div class="nearby-actions">
      <button id="nearbyRefresh">새로고침</button>
      <button id="nearbyClose">닫기</button>
    </div>
  </div>
  <div id="nearbyTips" class="nearby-empty" style="margin-top:8px"></div>
  <div id="nearbyList" class="nearby-list"></div>
</div>
<button id="fab-loc" class="fab">📍</button>
<button id="fab-add" class="fab">＋</button>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
const STORAGE_KEY='marker-memo-data-v3';
const GMAPS_KEY_STORAGE='gmaps_api_key_opt';
let gmapsReady=false; let placesService=null;
let map, markersLayer; const markers={};
function saveMarkers(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(Object.values(markers))); renderMarkerList(); }
function loadMarkers(){ try{ (JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')).forEach(m=>markers[m.id]=m);}catch(e){} }
function uid(){ return 'm'+Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
function buildPopup(m){ const created=new Date(m.created).toLocaleString(); const safe=(m.note||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); return `<div><small>${created}</small><textarea id="ta-${m.id}">${safe}</textarea><div style='text-align:right;'><button id='save-${m.id}' class='btn-sm'>저장</button><button id='delete-${m.id}' class='btn-sm'>삭제</button></div></div>`; }
function attachPopupEvents(id){ const s=document.getElementById('save-'+id), d=document.getElementById('delete-'+id), t=document.getElementById('ta-'+id); if(s) s.onclick=()=>{ markers[id].note=t.value; saveMarkers(); renderMapMarkers(); }; if(d) d.onclick=()=>{ if(confirm('삭제?')){ delete markers[id]; saveMarkers(); renderMapMarkers(); renderMarkerList(); } }; }
function renderMarkerList(){ const el=document.getElementById('markerList'); const arr=Object.values(markers); if(!arr.length){ el.style.display='none'; el.innerHTML=''; return; } el.style.display='block'; el.innerHTML=arr.map(m=>`<div class='m-item'><strong>${m.note||'(메모 없음)'}</strong><small>${new Date(m.created).toLocaleString()} — ${m.lat.toFixed(5)}, ${m.lng.toFixed(5)} <button class='btn-sm' onclick="map.setView([${m.lat},${m.lng}],16)">이동</button></small></div>`).join(''); }
function addMarker({lat,lng,note=''}){ const id=uid(); markers[id]={id,lat,lng,note,created:Date.now()}; saveMarkers(); renderMapMarkers(); map.setView([lat,lng],16); }
function renderMapMarkers(){ markersLayer.clearLayers(); Object.values(markers).forEach(m=>{ const mk=L.marker([m.lat,m.lng]).addTo(markersLayer); mk._markerId=m.id; mk.bindPopup(buildPopup(m)); mk.on('popupopen',()=>attachPopupEvents(m.id)); }); }
function exportMarkers(){ const blob=new Blob([JSON.stringify(Object.values(markers),null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='markers.json'; a.click(); URL.revokeObjectURL(url); }
function importMarkersFromFile(file){ const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); arr.forEach(m=>{ if(!m.id) m.id=uid(); markers[m.id]=m; }); saveMarkers(); renderMapMarkers(); renderMarkerList(); }catch(e){ alert('가져오기 실패'); } }; r.readAsText(file); }
function getCurrentPositionOnce(){ return new Promise((res,rej)=>{ navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true}); }); }
async function findNearbyRestaurants(){
  try {
    const pos = await getCurrentPositionOnce();
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const url = `https://www.google.com/maps/search/맛집/@${lat},${lng},15z`;
    window.open(url, '_blank');
  } catch (e) {
    alert('위치 정보를 가져올 수 없습니다: ' + e.message);
  }
}
window.addEventListener('load',()=>{
const headerEl=document.querySelector('header'); document.documentElement.style.setProperty('--header-h', headerEl.offsetHeight + 'px');
map=L.map('map').setView([37.5665,126.9780], 13);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
markersLayer=L.layerGroup().addTo(map);
loadMarkers(); renderMapMarkers(); renderMarkerList();
map.on('click',e=>{ const text=prompt('메모 입력:', ''); if(text!==null) addMarker({lat:e.latlng.lat,lng:e.latlng.lng,note:text||''}); });
const goCurrent=async()=>{ try{ const pos=await getCurrentPositionOnce(); map.setView([pos.coords.latitude,pos.coords.longitude],17); }catch(e){ alert(e.message); } };
document.getElementById('locBtn').onclick=goCurrent;
document.getElementById('markHereBtn').onclick=async()=>{ try{ const pos=await getCurrentPositionOnce(); const note=prompt('메모 입력:', ''); if(note!==null) addMarker({lat:pos.coords.latitude,lng:pos.coords.longitude,note:note||''}); }catch(e){ alert(e.message); } };
document.getElementById('addCenterBtn').onclick=()=>{ const c=map.getCenter(); const note=prompt('메모 입력:', ''); if(note!==null) addMarker({lat:c.lat,lng:c.lng,note:note||''}); };
document.getElementById('exportBtn').onclick=exportMarkers;
document.getElementById('importBtn').onclick=()=>document.getElementById('importFile').click();
document.getElementById('importFile').onchange=ev=>{ const f=ev.target.files[0]; if(f) importMarkersFromFile(f); };
document.getElementById('clearBtn').onclick=()=>{ if(confirm('모두 삭제?')){ for(const k in markers) delete markers[k]; saveMarkers(); renderMapMarkers(); renderMarkerList(); } };
document.getElementById('toggleListBtn').onclick=()=>{ const ml=document.getElementById('markerList'); ml.style.display=(ml.style.display==='none'||!ml.style.display)?'block':'none'; };
document.getElementById('fab-loc').onclick=goCurrent;
document.getElementById('fab-add').onclick=()=>{ const c=map.getCenter(); const note=prompt('메모 입력:', ''); if(note!==null) addMarker({lat:c.lat,lng:c.lng,note:note||''}); };

// === Nearby Restaurants (Google) ===
function gmapsLoad(key){ return new Promise((resolve,reject)=>{
  if (window.google && window.google.maps && window.google.maps.places){ gmapsReady=true; return resolve(); }
  const s=document.createElement('script');
  s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places&v=quarterly`;
  s.async=true; s.onerror=()=>reject(new Error('Google Maps JS 로딩 실패'));
  s.onload=()=>{ gmapsReady=true; resolve(); };
  document.head.appendChild(s);
}); }

async function ensurePlacesService(){
  if (placesService) return placesService;
  let key = localStorage.getItem(GMAPS_KEY_STORAGE);
  if (!key){
    key = prompt('Google Maps JavaScript API Key를 입력하세요 (없으면 취소)
※ 키가 없으면 구글 지도 검색 링크로 안내합니다.');
    if (key) localStorage.setItem(GMAPS_KEY_STORAGE, key);
  }
  if (key){ await gmapsLoad(key); placesService = new google.maps.places.PlacesService(document.createElement('div')); }
  return placesService;
}

function gmapsSearchLinks(lat,lng){
  const q = encodeURIComponent('맛집');
  const base = `https://www.google.com/maps/search/${q}/@${lat},${lng},16z`;
  const cats = ['맛집','카페','분식','중식','일식','한식','양식','바','디저트'];
  return {base, cats: cats.map(c=>({ name:c, url:`https://www.google.com/maps/search/${encodeURIComponent(c)}/@${lat},${lng},16z` }))};
}

async function showNearby(){
  const panel = document.getElementById('nearbyPanel');
  const list = document.getElementById('nearbyList');
  const tips = document.getElementById('nearbyTips');
  const where = document.getElementById('nearbyWhere');
  panel.style.display='block'; list.innerHTML=''; tips.textContent='검색 중...';
  let lat,lng;
  try { const pos = await getCurrentPositionOnce(); lat=pos.coords.latitude; lng=pos.coords.longitude; }
  catch(_) { const c = map.getCenter(); lat=c.lat; lng=c.lng; }
  where.textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;

  const svc = await ensurePlacesService();
  if (!svc){
    const links = gmapsSearchLinks(lat,lng);
    tips.innerHTML = `API 키가 없어 구글 지도 검색 링크로 안내합니다. 아래 링크를 탭하세요.`;
    list.innerHTML = `<div class='nearby-item'><b>열기</b>
      <div class='nearby-actions'><a class='pill' href='${links.base}' target='_blank'>맛집 검색 열기</a>
      ${links.cats.map(c=>`<a class='pill' href='${c.url}' target='_blank'>${c.name}</a>`).join(' ')}
      </div></div>`;
    return;
  }

  svc.nearbySearch({
    location: new google.maps.LatLng(lat,lng),
    rankBy: google.maps.places.RankBy.DISTANCE,
    type: ['restaurant']
  }, (results, status)=>{
    if (status !== google.maps.places.PlacesServiceStatus.OK || !results?.length){
      const links = gmapsSearchLinks(lat,lng);
      tips.textContent = '근처 결과를 불러올 수 없어 링크로 안내합니다.';
      list.innerHTML = `<div class='nearby-item'><b>열기</b>
        <div class='nearby-actions'><a class='pill' href='${links.base}' target='_blank'>맛집 검색 열기</a>
        ${links.cats.map(c=>`<a class='pill' href='${c.url}' target='_blank'>${c.name}</a>`).join(' ')}
        </div></div>`;
      return;
    }
    tips.textContent='';
    list.innerHTML = results.slice(0,12).map(r=>{
      const rating = r.rating ? `★ ${r.rating} (${r.user_ratings_total||0})` : '평점 없음';
      const addr = r.vicinity || '';
      const open = (r.opening_hours && r.opening_hours.isOpen()) ? '영업중' : '';
      const mapsUrl = `https://www.google.com/maps/place/?q=place_id:${r.place_id}`;
      return `<div class='nearby-item'>
        <b>${r.name}</b>
        <div style='font-size:12px;color:#555'>${rating} ${open}</div>
        <div style='font-size:12px;color:#666'>${addr}</div>
        <div class='nearby-actions'>
          <a class='pill' href='${mapsUrl}' target='_blank'>Google 지도로 열기</a>
          <button class='pill' data-add='${r.place_id}'>지도에 마커</button>
        </div>
      </div>`;
    }).join('');

    // 버튼 이벤트 바인딩
    list.querySelectorAll('button[data-add]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.getAttribute('data-add');
        const r = results.find(x=>x.place_id===id);
        if (!r || !r.geometry?.location) return;
        const ll = r.geometry.location; const lat=ll.lat(); const lng=ll.lng();
        addMarker({lat, lng, note:`${r.name} — ${r.vicinity||''} ${r.rating?`★${r.rating}`:''}`});
      });
    });
  });
}

document.getElementById('nearbyBtn').onclick = showNearby;
document.getElementById('nearbyRefresh').onclick = showNearby;
document.getElementById('nearbyClose').onclick = ()=>{ document.getElementById('nearbyPanel').style.display='none'; };

});
const goCurrent=async()=>{ try{ const pos=await getCurrentPositionOnce(); map.setView([pos.coords.latitude,pos.coords.longitude],17); }catch(e){ alert(e.message); } };
document.getElementById('locBtn').onclick=goCurrent;
document.getElementById('markHereBtn').onclick=async()=>{ try{ const pos=await getCurrentPositionOnce(); const note=prompt('메모 입력:', ''); if(note!==null) addMarker({lat:pos.coords.latitude,lng:pos.coords.longitude,note:note||''}); }catch(e){ alert(e.message); } };
document.getElementById('addCenterBtn').onclick=()=>{ const c=map.getCenter(); const note=prompt('메모 입력:', ''); if(note!==null) addMarker({lat:c.lat,lng:c.lng,note:note||''}); };
document.getElementById('exportBtn').onclick=exportMarkers;
document.getElementById('importBtn').onclick=()=>document.getElementById('importFile').click();
document.getElementById('importFile').onchange=ev=>{ const f=ev.target.files[0]; if(f) importMarkersFromFile(f); };
document.getElementById('clearBtn').onclick=()=>{ if(confirm('모두 삭제?')){ for(const k in markers) delete markers[k]; saveMarkers(); renderMapMarkers(); renderMarkerList(); } };
document.getElementById('toggleListBtn').onclick=()=>{ const ml=document.getElementById('markerList'); ml.style.display=(ml.style.display==='none'||!ml.style.display)?'block':'none'; };
document.getElementById('fab-loc').onclick=goCurrent;
document.getElementById('fab-add').onclick=()=>{ const c=map.getCenter(); const note=prompt('메모 입력:', ''); if(note!==null) addMarker({lat:c.lat,lng:c.lng,note:note||''}); };
document.getElementById('findFoodBtn').onclick=findNearbyRestaurants;
});
</script>
</body>
</html>
