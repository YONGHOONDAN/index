<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>위치 마커 & 메모 — PWA v3 (iPhone XS 최적화)</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="마커 & 메모" />
<meta name="theme-color" content="#1e90ff" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
:root { --header-h: 56px; }
html,body { height: 100%; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial, sans-serif; }
header { position: fixed; top: 0; left: 0; right: 0; background: #1e90ff; color: #fff; display:flex; flex-wrap:wrap; gap:6px; padding:6px; z-index:1000; }
header strong { font-size:16px; white-space:nowrap; }
header button { padding:8px 10px; font-size:14px; border-radius:6px; border:0; }
#map { position: absolute; top: var(--header-h); bottom: 0; left:0; right:0; }
#markerList { position: absolute; right: 8px; top: calc(var(--header-h) + 8px); width: 280px; max-height: 60vh; overflow:auto; background: rgba(255,255,255,0.98); padding:8px; border-radius:8px; z-index:1000; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
.m-item { padding:10px; border-bottom:1px solid #eee; }
.m-item small { color:#666; display:block; margin-top:6px; }
.btn-sm { padding:6px 8px; font-size:13px; margin-left:6px; border-radius:8px; }
textarea { width:100%; height:90px; font-family:inherit; border-radius:6px; padding:8px; }
#warn { position: fixed; bottom: 8px; left: 8px; right: 8px; background:#fff3cd; color:#664d03; border:1px solid #ffec99; border-radius:8px; padding:10px; display:none; z-index:1001; }
.fab { position: fixed; right: 14px; width: 54px; height: 54px; border-radius: 50%; border:0; box-shadow: 0 6px 16px rgba(0,0,0,0.25); background:#1e90ff; color:#fff; font-size:22px; z-index:1002; }
#fab-add { bottom: 20px; }
#fab-loc { bottom: 84px; }
</style>
</head>
<body>
<header>
<strong>위치 마커 & 메모</strong>
<button id="locBtn">현재 위치로 이동</button>
<button id="markHereBtn">현재 위치에 마커</button>
<button id="addCenterBtn">현재 중심에 마커</button>
<button id="toggleListBtn">마커 목록</button>
<button id="exportBtn">내보내기</button>
<button id="importBtn">가져오기</button>
<input id="importFile" type="file" accept="application/json" style="display:none">
<button id="clearBtn">모두 삭제</button>
</header>
<div id="map"></div>
<div id="markerList" style="display:none"></div>
<div id="warn"></div>
<button id="fab-loc" class="fab">📍</button>
<button id="fab-add" class="fab">＋</button>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
const STORAGE_KEY='marker-memo-data-v3';
let map, markersLayer; const markers={};
function saveMarkers(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(Object.values(markers))); renderMarkerList(); }
function loadMarkers(){ try{ (JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')).forEach(m=>markers[m.id]=m);}catch(e){} }
function uid(){ return 'm'+Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
function buildPopup(m){ const created=new Date(m.created).toLocaleString(); const safe=(m.note||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); return `<div><small>${created}</small><textarea id="ta-${m.id}">${safe}</textarea><div style='text-align:right;'><button id='save-${m.id}' class='btn-sm'>저장</button><button id='delete-${m.id}' class='btn-sm'>삭제</button></div></div>`; }
function attachPopupEvents(id){ const s=document.getElementById('save-'+id), d=document.getElementById('delete-'+id), t=document.getElementById('ta-'+id); if(s) s.onclick=()=>{ markers[id].note=t.value; saveMarkers(); renderMapMarkers(); }; if(d) d.onclick=()=>{ if(confirm('삭제?')){ delete markers[id]; saveMarkers(); renderMapMarkers(); renderMarkerList(); } }; }
function renderMarkerList(){ const el=document.getElementById('markerList'); const arr=Object.values(markers); if(!arr.length){ el.style.display='none'; el.innerHTML=''; return; } el.style.display='block'; el.innerHTML=arr.map(m=>`<div class='m-item'><strong>${m.note||'(메모 없음)'}</strong><small>${new Date(m.created).toLocaleString()} — ${m.lat.toFixed(5)}, ${m.lng.toFixed(5)} <button class='btn-sm' onclick="map.setView([${m.lat},${m.lng}],16)">이동</button></small></div>`).join(''); }
function addMarker({lat,lng,note=''}){ const id=uid(); markers[id]={id,lat,lng,note,created:Date.now()}; saveMarkers(); renderMapMarkers(); map.setView([lat,lng],16); }
function renderMapMarkers(){ markersLayer.clearLayers(); Object.values(markers).forEach(m=>{ const mk=L.marker([m.lat,m.lng]).addTo(markersLayer); mk._markerId=m.id; mk.bindPopup(buildPopup(m)); mk.on('popupopen',()=>attachPopupEvents(m.id)); }); }
function exportMarkers(){ const blob=new Blob([JSON.stringify(Object.values(markers),null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='markers.json'; a.click(); URL.revokeObjectURL(url); }
function importMarkersFromFile(file){ const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); arr.forEach(m=>{ if(!m.id) m.id=uid(); markers[m.id]=m; }); saveMarkers(); renderMapMarkers(); renderMarkerList(); }catch(e){ alert('가져오기 실패'); } }; r.readAsText(file); }
function getCurrentPositionOnce(){ return new Promise((res,rej)=>{ navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true}); }); }
window.addEventListener('load',()=>{
const headerEl=document.querySelector('header'); document.documentElement.style.setProperty('--header-h', headerEl.offsetHeight + 'px');
map=L.map('map').setView([37.5665,126.9780], 13);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
markersLayer=L.layerGroup().addTo(map);
loadMarkers(); renderMapMarkers(); renderMarkerList();
map.on('click',e=>{ const text=prompt('메모 입력:', ''); if(text!==null) addMarker({lat:e.latlng.lat,lng:e.latlng.lng,note:text||''}); });
const goCurrent=async()=>{ try{ const pos=await getCurrentPositionOnce(); map.setView([pos.coords.latitude,pos.coords.longitude],17); }catch(e){ alert(e.message); } };
document.getElementById('locBtn').onclick=goCurrent;
document.getElementById('markHereBtn').onclick=async()=>{ try{ const pos=await getCurrentPositionOnce(); const note=prompt('메모 입력:', ''); if(note!==null) addMarker({lat:pos.coords.latitude,lng:pos.coords.longitude,note:note||''}); }catch(e){ alert(e.message); } };
document.getElementById('addCenterBtn').onclick=()=>{ const c=map.getCenter(); const note=prompt('메모 입력:', ''); if(note!==null) addMarker({lat:c.lat,lng:c.lng,note:note||''}); };
document.getElementById('exportBtn').onclick=exportMarkers;
document.getElementById('importBtn').onclick=()=>document.getElementById('importFile').click();
document.getElementById('importFile').onchange=ev=>{ const f=ev.target.files[0]; if(f) importMarkersFromFile(f); };
document.getElementById('clearBtn').onclick=()=>{ if(confirm('모두 삭제?')){ for(const k in markers) delete markers[k]; saveMarkers(); renderMapMarkers(); renderMarkerList(); } };
document.getElementById('toggleListBtn').onclick=()=>{ const ml=document.getElementById('markerList'); ml.style.display=(ml.style.display==='none'||!ml.style.display)?'block':'none'; };
document.getElementById('fab-loc').onclick=goCurrent;
document.getElementById('fab-add').onclick=()=>{ const c=map.getCenter(); const note=prompt('메모 입력:', ''); if(note!==null) addMarker({lat:c.lat,lng:c.lng,note:note||''}); };
});
</script>
</body>
</html>
