<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>위치 마커 & 메모 — PWA v4 (API-free)</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="마커 & 메모" />
  <meta name="theme-color" content="#1e90ff" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root { --header-h: 56px; }
    html,body { height: 100%; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial, sans-serif; }
    header { position: fixed; top: 0; left: 0; right: 0; background: #1e90ff; color: #fff; display:flex; flex-wrap:wrap; align-items:center; gap:6px; padding:6px; z-index:1000; }
    header strong { font-size:16px; white-space:nowrap; }
    header button { padding:8px 10px; font-size:14px; border-radius:6px; border:0; }
    #map { position: absolute; top: var(--header-h); bottom: 0; left:0; right:0; }
    #markerList { position: absolute; right: 8px; top: calc(var(--header-h) + 8px); width: 280px; max-height: 60vh; overflow:auto; background: rgba(255,255,255,0.98); padding:8px; border-radius:8px; z-index:1000; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
    .m-item { padding:10px; border-bottom:1px solid #eee; }
    .m-item small { color:#666; display:block; margin-top:6px; }
    .btn-sm { padding:6px 8px; font-size:13px; margin-left:6px; border-radius:8px; }
    textarea { width:100%; height:90px; font-family:inherit; border-radius:6px; padding:8px; }
    #warn { position: fixed; bottom: 8px; left: 8px; right: 8px; background:#fff3cd; color:#664d03; border:1px solid #ffec99; border-radius:8px; padding:10px; display:none; z-index:1001; }
    .fab { position: fixed; right: 14px; width: 54px; height: 54px; border-radius: 50%; border:0; box-shadow: 0 6px 16px rgba(0,0,0,0.25); background:#1e90ff; color:#fff; font-size:22px; z-index:1002; }
    #fab-add { bottom: 20px; }
    #fab-loc { bottom: 84px; }
  </style>
</head>
<body>
  <header>
    <strong>위치 마커 & 메모</strong>
    <button id="locBtn">현재 위치로 이동</button>
    <button id="markHereBtn">현재 위치에 마커</button>
    <button id="addCenterBtn">현재 중심에 마커</button>
    <button id="toggleListBtn">마커 목록</button>
    <button id="findFoodBtn">주변 맛집</button>
    <button id="exportBtn">내보내기</button>
    <button id="importBtn">가져오기</button>
    <input id="importFile" type="file" accept="application/json" style="display:none">
    <button id="clearBtn">모두 삭제</button>
  </header>

  <div id="map" aria-label="지도"></div>
  <div id="markerList" style="display:none"></div>
  <div id="warn"></div>

  <button id="fab-loc" class="fab" title="현재 위치로 이동">📍</button>
  <button id="fab-add" class="fab" title="현재 중심에 마커">＋</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // ===== 상태/유틸 =====
    const STORAGE_KEY = 'marker-memo-data-v4';
    let map, markersLayer; const markers = {};

    function showWarn(msg){ const w=document.getElementById('warn'); w.innerHTML=msg; w.style.display='block'; clearTimeout(showWarn._t); showWarn._t=setTimeout(()=>w.style.display='none', 6000); }
    function uid(){ return 'm'+Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
    function saveMarkers(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(Object.values(markers))); renderMarkerList(); }
    function loadMarkers(){ try{ (JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')).forEach(m=>markers[m.id]=m);}catch(e){} }

    // ===== 마커 UI =====
    function buildPopup(m){ const created=new Date(m.created).toLocaleString(); const safe=(m.note||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); return `<div style="min-width:220px;"><div><small>생성: ${created}</small></div><textarea id="ta-${m.id}" placeholder="메모 입력...">${safe}</textarea><div style='text-align:right;margin-top:6px;'><button id='save-${m.id}' class='btn-sm'>저장</button><button id='delete-${m.id}' class='btn-sm'>삭제</button></div></div>`; }
    function attachPopupEvents(id){ const s=document.getElementById('save-'+id), d=document.getElementById('delete-'+id), t=document.getElementById('ta-'+id); if(s) s.onclick=()=>{ markers[id].note=t.value; saveMarkers(); renderMapMarkers(); }; if(d) d.onclick=()=>{ if(confirm('삭제할까요?')){ delete markers[id]; saveMarkers(); renderMapMarkers(); renderMarkerList(); } }; }
    function renderMarkerList(){ const el=document.getElementById('markerList'); const arr=Object.values(markers).sort((a,b)=>a.created-b.created); if(!arr.length){ el.style.display='none'; el.innerHTML=''; return; } el.style.display='block'; el.innerHTML='<strong>저장된 마커</strong><div style="height:8px"></div>'+arr.map(m=>`<div class='m-item'><div><strong>${(m.note||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')||'(메모 없음)'}</strong></div><small>${new Date(m.created).toLocaleString()} — ${m.lat.toFixed(5)}, ${m.lng.toFixed(5)} <button class='btn-sm' data-pan='${m.id}'>이동</button> <button class='btn-sm' data-open='${m.id}'>팝업</button> <button class='btn-sm' data-del='${m.id}'>삭제</button></small></div>`).join(''); el.querySelectorAll('button').forEach(b=>{ const id=b.dataset.pan||b.dataset.open||b.dataset.del; if(b.dataset.pan) b.onclick=()=>map.setView([markers[id].lat,markers[id].lng], Math.max(map.getZoom(),16)); if(b.dataset.open) b.onclick=()=>markersLayer.eachLayer(l=>{ if(l._markerId===id) l.openPopup(); }); if(b.dataset.del) b.onclick=()=>{ if(confirm('삭제하시겠어요?')){ delete markers[id]; saveMarkers(); renderMapMarkers(); renderMarkerList(); } }; }); }
    function addMarker({lat,lng,note=''}){ const id=uid(); markers[id]={id,lat,lng,note,created:Date.now()}; saveMarkers(); renderMapMarkers(); map.setView([lat,lng], Math.max(map.getZoom(),16)); setTimeout(()=>{ markersLayer.eachLayer(l=>{ if(l._markerId===id) l.openPopup(); }); }, 120); }
    function renderMapMarkers(){ markersLayer.clearLayers(); Object.values(markers).forEach(m=>{ const mk=L.marker([m.lat,m.lng],{title:(m.note||'메모 없음').slice(0,30)}).addTo(markersLayer); mk._markerId=m.id; mk.bindPopup(buildPopup(m)); mk.on('popupopen',()=>attachPopupEvents(m.id)); }); }

    function exportMarkers(){ const blob=new Blob([JSON.stringify(Object.values(markers), null, 2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=Object.assign(document.createElement('a'),{href:url,download:'markers.json'}); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    function importMarkersFromFile(file){ const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); if(!Array.isArray(arr)) throw new Error('JSON 배열 아님'); arr.forEach(m=>{ if(!m.id) m.id=uid(); markers[m.id]=m; }); saveMarkers(); renderMapMarkers(); renderMarkerList(); alert('가져오기 완료'); }catch(e){ alert('가져오기 실패: '+e.message); } }; r.readAsText(file); }
    function getCurrentPositionOnce(){ return new Promise((res,rej)=>{ if(!('geolocation'in navigator)) return rej(new Error('이 브라우저는 위치 정보를 지원하지 않습니다.')); navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:10000,maximumAge:0}); }); }

    // ===== 초기화 =====
    window.addEventListener('load', ()=>{
      // 헤더 높이 반영
      const headerEl=document.querySelector('header'); document.documentElement.style.setProperty('--header-h', headerEl.offsetHeight + 'px');

      // 지도 생성
      try{ map=L.map('map'); }catch(e){ alert('지도를 초기화하지 못했습니다. 콘솔을 확인하세요.'); console.error(e); return; }
      map.setView([37.5665,126.9780], 13);

      // 타일 서버 폴백
      const tileUrls=['https://tile.openstreetmap.org/{z}/{x}/{y}.png','https://a.tile.openstreetmap.org/{z}/{x}/{y}.png','https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png'];
      let tileIndex=0; let tileLayer; function useNextTileLayer(){ if(tileLayer){ try{ map.removeLayer(tileLayer);}catch(_){} } const url=tileUrls[tileIndex%tileUrls.length]; tileIndex++; tileLayer=L.tileLayer(url,{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}); tileLayer.on('tileerror',()=>{ showWarn('<b>지도 타일 로딩 실패</b> 다른 서버로 전환합니다.'); useNextTileLayer(); }); tileLayer.on('load',()=>{ const w=document.getElementById('warn'); if(w) w.style.display='none'; }); tileLayer.addTo(map);} useNextTileLayer();

      // 레이어 & 기존 데이터
      markersLayer=L.layerGroup().addTo(map);
      loadMarkers(); renderMapMarkers(); renderMarkerList();

      // 지도 클릭 → 마커 추가
      map.on('click', e=>{ const text=prompt('이 위치에 마커를 추가합니다. 메모를 입력하세요:', ''); if(text===null) return; addMarker({lat:e.latlng.lat,lng:e.latlng.lng,note:text||''}); });

      // 버튼 핸들러
      const goCurrent=async()=>{ try{ const pos=await getCurrentPositionOnce(); map.setView([pos.coords.latitude,pos.coords.longitude],17); }catch(err){ alert('현재 위치를 가져오지 못했습니다: '+err.message); } };
      const addCenter=()=>{ const c=map.getCenter(); const note=prompt('지도 중심에 마커를 추가합니다. 메모를 입력하세요:', ''); if(note===null) return; addMarker({lat:c.lat,lng:c.lng,note:note||''}); };
      document.getElementById('locBtn').onclick=goCurrent;
      document.getElementById('markHereBtn').onclick=async()=>{ try{ const pos=await getCurrentPositionOnce(); const note=prompt('현재 위치에 마커를 추가합니다. 메모를 입력하세요:', ''); if(note===null) return; addMarker({lat:pos.coords.latitude,lng:pos.coords.longitude,note:note||''}); }catch(err){ alert('현재 위치를 가져오지 못했습니다: '+err.message); } };
      document.getElementById('addCenterBtn').onclick=addCenter;
      document.getElementById('exportBtn').onclick=exportMarkers;
      document.getElementById('importBtn').onclick=()=>document.getElementById('importFile').click();
      document.getElementById('importFile').onchange=ev=>{ const f=ev.target.files[0]; if(f) importMarkersFromFile(f); };
      document.getElementById('clearBtn').onclick=()=>{ if(confirm('모든 마커를 삭제합니다. 복구 불가. 진행할까요?')){ for(const k in markers) delete markers[k]; saveMarkers(); renderMapMarkers(); renderMarkerList(); } };
      document.getElementById('toggleListBtn').onclick=()=>{ const ml=document.getElementById('markerList'); ml.style.display=(ml.style.display==='none'||!ml.style.display)?'block':'none'; };

      // FAB
      document.getElementById('fab-loc').onclick=goCurrent;
      document.getElementById('fab-add').onclick=addCenter;

      // 주변 맛집(링크 모드, API 미사용)
      document.getElementById('findFoodBtn').onclick=async()=>{
        try{
          const pos=await getCurrentPositionOnce();
          const lat=pos.coords.latitude, lng=pos.coords.longitude;
          const q=encodeURIComponent('맛집');
          window.open(`https://www.google.com/maps/search/${q}/@${lat},${lng},16z`, '_blank');
        }catch(_){
          const c=map.getCenter();
          const q=encodeURIComponent('맛집');
          window.open(`https://www.google.com/maps/search/${q}/@${c.lat},${c.lng},16z`, '_blank');
        }
      };
    });

    // ===== (선택) PWA: 단일 파일용 가벼운 매니페스트/서비스워커 =====
    (function(){
      function makeIcon(size){ const c=document.createElement('canvas'); c.width=c.height=size; const x=c.getContext('2d'); x.fillStyle='#1e90ff'; x.fillRect(0,0,size,size); x.fillStyle='#fff'; const r=size*0.18, cx=size*0.5, cy=size*0.45; x.beginPath(); x.arc(cx,cy,r,0,Math.PI*2); x.fill(); x.beginPath(); x.moveTo(cx, cy + r*0.9); x.lineTo(cx - r*0.6, cy + r*2.2); x.lineTo(cx + r*0.6, cy + r*2.2); x.closePath(); x.fill(); return c.toDataURL('image/png'); }
      const icon192=makeIcon(192), icon512=makeIcon(512);
      const appleIcon=document.createElement('link'); appleIcon.rel='apple-touch-icon'; appleIcon.href=icon192; document.head.appendChild(appleIcon);
      const manifest={ name:'위치 마커 & 메모', short_name:'마커&메모', start_url:'/index/', scope:'/index/', display:'standalone', background_color:'#ffffff', theme_color:'#1e90ff', icons:[{src:icon192,sizes:'192x192',type:'image/png'},{src:icon512,sizes:'512x512',type:'image/png'}] };
      const mblob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'}); const mlink=document.createElement('link'); mlink.rel='manifest'; mlink.href=URL.createObjectURL(mblob); document.head.appendChild(mlink);
      if('serviceWorker' in navigator){
        const swCode = `const CACHE='marker-memo-v5';const ASSETS=['/index/','/index/index.html'];self.addEventListener('install',e=>{e.waitUntil((async()=>{const c=await caches.open(CACHE);try{await c.addAll(ASSETS);}catch(_){};self.skipWaiting();})())});self.addEventListener('activate',e=>{e.waitUntil((async()=>{const ks=await caches.keys();await Promise.all(ks.map(k=>{if(k!==CACHE)return caches.delete(k)}));await self.clients.claim();})())});self.addEventListener('fetch',e=>{const req=e.request;e.respondWith((async()=>{const cached=await caches.match(req);if(cached)return cached;try{const res=await fetch(req);const c=await caches.open(CACHE);if(req.method==='GET'&&new URL(req.url).origin===location.origin)c.put(req,res.clone());return res}catch(err){if(req.mode==='navigate'){const root=await caches.match('/index/index.html');if(root)return root;}throw err}})())});`;
        const swBlob=new Blob([swCode],{type:'text/javascript'});
        const swUrl=URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl).catch(console.warn);
      }
    })();
  </script>
</body>
</html>
