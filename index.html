<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>위치 마커 & 메모 — PWA v3</title>

  <!-- iOS PWA 필수 메타 -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="마커 & 메모" />
  <meta name="theme-color" content="#1e90ff" />
  <!-- 홈화면 아이콘은 아래 스크립트에서 동적으로 생성/주입 -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e90ff"/>
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>body,html{margin:0;height:100%}iframe{border:0;width:100%;height:100%}</style>
</head>
<body>
<iframe src="index-map.html"></iframe>
<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(console.error);
}
</script>
  <script>
  // ===== PWA: manifest + service worker (단일 파일용 동적 생성) =====
  (function(){
    // 1) 아이콘 PNG 동적 생성 (512, 192)
    function makeIcon(size){
      const c = document.createElement('canvas'); c.width = c.height = size; const ctx = c.getContext('2d');
      // 배경
      ctx.fillStyle = '#1e90ff'; ctx.fillRect(0,0,size,size);
      // 핀 모양 간단 드로잉
      ctx.fillStyle = '#ffffff';
      const r = size*0.18; const cx = size*0.5; const cy = size*0.45;
      ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.moveTo(cx, cy + r*0.9); ctx.lineTo(cx - r*0.6, cy + r*2.2); ctx.lineTo(cx + r*0.6, cy + r*2.2); ctx.closePath(); ctx.fill();
      return c.toDataURL('image/png');
    }

    const icon512 = makeIcon(512);
    const icon192 = makeIcon(192);

    // iOS 홈화면 아이콘(apple-touch-icon)
    const appleIcon = document.createElement('link');
    appleIcon.rel = 'apple-touch-icon';
    appleIcon.href = icon192; // iOS가 180/192 등 유연히 처리
    document.head.appendChild(appleIcon);

    // 2) Manifest 동적 생성
    const manifest = {
      name: '위치 마커 & 메모',
      short_name: '마커&메모',
      description: '원하는 위치에 마커와 메모를 저장하는 오프라인 지원 웹앱',
      start_url: '.',
      scope: '.',
      display: 'standalone',
      background_color: '#ffffff',
      theme_color: '#1e90ff',
      icons: [
        { src: icon192, sizes: '192x192', type: 'image/png' },
        { src: icon512, sizes: '512x512', type: 'image/png' }
      ]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
    const mlink = document.createElement('link');
    mlink.rel = 'manifest';
    mlink.href = URL.createObjectURL(blob);
    document.head.appendChild(mlink);

    // 3) Service Worker 동적 등록 (오프라인 캐시)
    if ('serviceWorker' in navigator) {
      const swCode = `
        const CACHE = 'marker-memo-v3';
        const ASSETS = [
          './',
          location.pathname.endsWith('/') ? location.pathname : location.pathname.split('/').slice(0,-1).join('/') + '/',
        ];
        self.addEventListener('install', e => {
          e.waitUntil((async()=>{ const c = await caches.open(CACHE); try{ await c.addAll(ASSETS);}catch(_){}; self.skipWaiting(); })());
        });
        self.addEventListener('activate', e => {
          e.waitUntil((async()=>{ const keys = await caches.keys(); await Promise.all(keys.map(k=>{ if(k!==CACHE) return caches.delete(k); })); await self.clients.claim(); })());
        });
        self.addEventListener('fetch', e => {
          const req = e.request;
          // 우선 캐시, 없으면 네트워크, 성공 시 캐시에 넣기
          e.respondWith((async()=>{
            const cached = await caches.match(req); if (cached) return cached;
            try {
              const res = await fetch(req);
              const c = await caches.open(CACHE);
              // GET & same-origin만 캐시 시도
              if (req.method === 'GET' && new URL(req.url).origin === location.origin) c.put(req, res.clone());
              return res;
            } catch(err){
              // 오프라인일 때 기본 페이지 제공
              if (req.mode === 'navigate') {
                const root = await caches.match('./'); if (root) return root;
              }
              throw err;
            }
          })());
        });
      `;
      const swBlob = new Blob([swCode], {type:'text/javascript'});
      const swUrl = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl).catch(console.warn);
    }

    // iOS에선 자동 설치 배너가 없으니 첫 방문 시 안내(한 번만)
    try{
      const k = 'a2hs_hint_shown_v1';
      if (!localStorage.getItem(k) && /iPad|iPhone|iPod/.test(navigator.userAgent)) {
        showWarn('<b>팁</b> 홈 화면에 추가하려면 Safari 공유 버튼 → "홈 화면에 추가"를 탭하세요.');
        localStorage.setItem(k, '1');
      }
    }catch(_){}
  })();
  </script>
</body>
</html>
