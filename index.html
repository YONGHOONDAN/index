<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>위치 마커 & 메모 — PWA v4 (API‑free + 리스트)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root { --header-h: 56px; --panel-h: 40vh; }
    html,body { height: 100%; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial, sans-serif; }
    header { position: fixed; top: 0; left: 0; right: 0; background: #1e90ff; color: #fff; display:flex; flex-wrap:wrap; align-items:center; gap:6px; padding:6px; z-index:1000; }
    header strong { font-size:16px; white-space:nowrap; margin-right:6px; }
    header button { padding:8px 10px; font-size:14px; border-radius:8px; border:0; }

    #map { position:absolute; top: var(--header-h); left:0; right:0; bottom: 0; transition: bottom .2s ease; }
    #resultsPanel.open ~ #map { bottom: var(--panel-h); }

    /* 하단 패널 */
    #resultsPanel { position: fixed; left:0; right:0; bottom:0; height: var(--panel-h); background:#fff; border-top-left-radius:14px; border-top-right-radius:14px; box-shadow: 0 -8px 24px rgba(0,0,0,.25); z-index:1100; transform: translateY(calc(100% - 44px)); transition: transform .25s ease; }
    #resultsPanel.open { transform: translateY(0); }
    .rp-head { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #eee; }
    .rp-title { display:flex; align-items:center; gap:8px; }
    .pill { display:inline-block; padding:4px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; background:#fafafa; }
    .rp-body { height: calc(var(--panel-h) - 48px); overflow:auto; padding:10px 12px; }
    .cat-row { margin-bottom:8px; }
    .cat-row .pill { margin-right:6px; margin-bottom:6px; cursor:pointer; }

    .list { display:grid; grid-template-columns: 1fr; gap:8px; }
    .item { border:1px solid #eee; border-radius:10px; padding:10px; }
    .item b { display:block; margin-bottom:4px; }
    .meta { font-size:12px; color:#666; }
    .actions { margin-top:6px; display:flex; gap:6px; flex-wrap:wrap; }

    /* 모바일 보정 */
    @media (max-width: 420px){ :root{ --panel-h: 50vh; } }
  </style>
</head>
<body>
  <header>
    <strong>위치 마커 & 메모</strong>
    <button id="locBtn">현재 위치로 이동</button>
    <button id="addCenterBtn">현재 중심에 마커</button>
    <button id="togglePanelBtn">맛집 리스트</button>
    <button id="exportBtn">내보내기</button>
    <button id="importBtn">가져오기</button>
    <input id="importFile" type="file" accept="application/json" style="display:none" />
    <button id="clearBtn">모두 삭제</button>
  </header>

  <div id="map" aria-label="지도"></div>

  <!-- 하단 패널: API 없이 동작 (내가 저장한 마커 + 구글지도 링크) -->
  <section id="resultsPanel" aria-label="주변 맛집">
    <div class="rp-head">
      <div class="rp-title">
        <strong>주변 맛집</strong>
        <span id="where" class="pill"></span>
      </div>
      <div class="rp-actions">
        <button id="refreshBtn" class="pill">새로고침</button>
        <button id="closeBtn" class="pill">닫기</button>
      </div>
    </div>
    <div class="rp-body">
      <div class="cat-row">
        <span id="openMaps" class="pill" title="구글 지도 검색 열기">Google 지도로 열기</span>
        <span class="pill" data-cat="맛집">맛집</span>
        <span class="pill" data-cat="카페">카페</span>
        <span class="pill" data-cat="분식">분식</span>
        <span class="pill" data-cat="한식">한식</span>
        <span class="pill" data-cat="일식">일식</span>
        <span class="pill" data-cat="중식">중식</span>
        <span class="pill" data-cat="양식">양식</span>
        <span class="pill" data-cat="디저트">디저트</span>
        <span class="pill" data-cat="바">바</span>
      </div>
      <div class="meta" id="hint">※ 외부 API 없이 동작합니다. 아래 목록은 "내가 저장한 마커"를 현재 위치(또는 지도 중심)에서 가까운 순으로 정렬해 보여줍니다.</div>
      <div id="list" class="list"></div>
    </div>
  </section>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // ===== 상태/유틸 =====
    const STORAGE_KEY='marker-memo-v4';
    let map, markersLayer; const markers={};

    function uid(){ return 'm'+Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(Object.values(markers))); }
    function load(){ try{ (JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')).forEach(m=>markers[m.id]=m); }catch(e){} }
    function showToast(msg){ const n=document.createElement('div'); n.textContent=msg; Object.assign(n.style,{position:'fixed',left:'50%',bottom:'16px',transform:'translateX(-50%)',background:'#333',color:'#fff',padding:'8px 12px',borderRadius:'8px',zIndex:2000,opacity:'0.95'}); document.body.appendChild(n); setTimeout(()=>n.remove(),2000); }
    function getCurrentPositionOnce(){ return new Promise((res,rej)=>{ if(!('geolocation'in navigator)) return rej(new Error('위치 미지원')); navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:10000,maximumAge:0}); }); }
    function haversine(lat1,lon1,lat2,lon2){ const R=6371000, toRad=x=>x*Math.PI/180; const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
    function fmtDist(m){ return m<1000? `${Math.round(m)}m` : `${(m/1000).toFixed(2)}km`; }

    // ===== 마커 UI =====
    function popupHtml(m){ const safe=(m.note||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); const created=new Date(m.created).toLocaleString();
      return `<div style="min-width:220px;">
        <div><small>${created}</small></div>
        <textarea id="ta-${m.id}" style="width:100%;height:84px;">${safe}</textarea>
        <div style="text-align:right;margin-top:6px;">
          <button id="sv-${m.id}" class="btn-sm">저장</button>
          <button id="del-${m.id}" class="btn-sm">삭제</button>
        </div>
      </div>`; }
    function bindPopupEvents(id){ const s=document.getElementById('sv-'+id), d=document.getElementById('del-'+id), t=document.getElementById('ta-'+id); if(s) s.onclick=()=>{ markers[id].note=t.value; save(); renderMarkers(); renderList(); showToast('저장됨'); }; if(d) d.onclick=()=>{ if(confirm('삭제할까요?')){ delete markers[id]; save(); renderMarkers(); renderList(); } }; }

    function addMarker({lat,lng,note=''}){ const id=uid(); markers[id]={id,lat,lng,note,created:Date.now()}; save(); renderMarkers(); renderList(); map.setView([lat,lng], Math.max(map.getZoom(),16)); setTimeout(()=>{ markersLayer.eachLayer(l=>{ if(l._id===id) l.openPopup(); }); },120); }
    function renderMarkers(){ markersLayer.clearLayers(); Object.values(markers).forEach(m=>{ const mk=L.marker([m.lat,m.lng],{title:(m.note||'메모 없음').slice(0,30)}).addTo(markersLayer); mk._id=m.id; mk.bindPopup(popupHtml(m)); mk.on('popupopen',()=>bindPopupEvents(m.id)); }); }

    // ===== 리스트 패널 =====
    async function currentOrCenter(){ try{ const p=await getCurrentPositionOnce(); return {lat:p.coords.latitude,lng:p.coords.longitude, from:'현재 위치'}; } catch(_){ const c=map.getCenter(); return {lat:c.lat,lng:c.lng, from:'지도 중심'}; } }
    function gmapsUrl(lat,lng,q='맛집'){ return `https://www.google.com/maps/search/${encodeURIComponent(q)}/@${lat},${lng},16z`; }

    async function renderList(){ const {lat,lng,from}=await currentOrCenter(); document.getElementById('where').textContent=`${from} · ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
      const list=document.getElementById('list'); const arr=Object.values(markers).map(m=>({...m, dist:haversine(lat,lng,m.lat,m.lng)})).sort((a,b)=>a.dist-b.dist);
      if(!arr.length){ list.innerHTML = `<div class='meta'>저장된 마커가 없습니다. 지도를 탭해 먼저 마커를 추가해 보세요.</div>`; return; }
      list.innerHTML = arr.slice(0,40).map(m=>`<div class='item'>
        <b>${(m.note||'메모 없음').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</b>
        <div class='meta'>${fmtDist(m.dist)} · ${m.lat.toFixed(5)}, ${m.lng.toFixed(5)}</div>
        <div class='actions'>
          <button class='pill' data-pan='${m.id}'>지도로 이동</button>
          <button class='pill' data-open='${m.id}'>팝업</button>
          <a class='pill' href='${gmapsUrl(m.lat,m.lng)}' target='_blank'>구글지도 열기</a>
        </div>
      </div>`).join('');
      list.querySelectorAll('button').forEach(b=>{ const id=b.dataset.pan||b.dataset.open; if(b.dataset.pan) b.onclick=()=>map.setView([markers[id].lat,markers[id].lng], Math.max(map.getZoom(),16)); if(b.dataset.open) b.onclick=()=>markersLayer.eachLayer(l=>{ if(l._id===id) l.openPopup(); }); });
    }

    // ===== 초기화 =====
    window.addEventListener('load', ()=>{
      // 헤더 높이 반영
      const headerEl=document.querySelector('header'); document.documentElement.style.setProperty('--header-h', headerEl.offsetHeight + 'px');

      // 지도
      map=L.map('map').setView([37.5665,126.9780],13);
      const tiles=['https://tile.openstreetmap.org/{z}/{x}/{y}.png','https://a.tile.openstreetmap.org/{z}/{x}/{y}.png','https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png'];
      let ti=0, tl; (function next(){ if(tl){ try{ map.removeLayer(tl);}catch(e){} } const u=tiles[ti++%tiles.length]; tl=L.tileLayer(u,{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}); tl.on('tileerror',()=>next()); tl.addTo(map); })();

      markersLayer=L.layerGroup().addTo(map);
      load(); renderMarkers();

      // 지도 클릭으로 마커 추가
      map.on('click', e=>{ const text=prompt('이 위치에 마커를 추가합니다. 메모를 입력하세요:', ''); if(text===null) return; addMarker({lat:e.latlng.lat,lng:e.latlng.lng,note:text||''}); });

      // 버튼들
      document.getElementById('locBtn').onclick=async()=>{ try{ const p=await getCurrentPositionOnce(); map.setView([p.coords.latitude,p.coords.longitude],17);}catch(e){ alert('현재 위치를 가져오지 못했습니다: '+e.message);} };
      document.getElementById('addCenterBtn').onclick=()=>{ const c=map.getCenter(); const t=prompt('지도 중심에 마커를 추가합니다. 메모를 입력하세요:', ''); if(t===null) return; addMarker({lat:c.lat,lng:c.lng,note:t||''}); };
      document.getElementById('togglePanelBtn').onclick=async()=>{ document.getElementById('resultsPanel').classList.toggle('open'); await renderList(); };
      document.getElementById('refreshBtn').onclick=renderList;
      document.getElementById('closeBtn').onclick=()=>document.getElementById('resultsPanel').classList.remove('open');
      document.getElementById('openMaps').onclick=async()=>{ const {lat,lng}=await currentOrCenter(); window.open(gmapsUrl(lat,lng,'맛집'),'_blank'); };
      document.querySelectorAll('[data-cat]').forEach(el=> el.addEventListener('click', async ()=>{ const {lat,lng}=await currentOrCenter(); window.open(gmapsUrl(lat,lng, el.getAttribute('data-cat')),'_blank'); }));

      // 내보내기/가져오기/삭제
      document.getElementById('exportBtn').onclick=()=>{ const blob=new Blob([JSON.stringify(Object.values(markers),null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='markers.json'; a.click(); URL.revokeObjectURL(url); };
      document.getElementById('importBtn').onclick=()=>document.getElementById('importFile').click();
      document.getElementById('importFile').onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); if(!Array.isArray(arr)) throw new Error('JSON 배열 아님'); arr.forEach(m=>{ if(!m.id) m.id=uid(); markers[m.id]=m; }); save(); renderMarkers(); renderList(); showToast('가져오기 완료'); }catch(err){ alert('가져오기 실패: '+err.message);} }; r.readAsText(f); e.target.value=''; };
      document.getElementById('clearBtn').onclick=()=>{ if(confirm('모든 마커를 삭제합니다. 진행할까요?')){ for(const k in markers) delete markers[k]; save(); renderMarkers(); renderList(); } };
    });
  </script>
</body>
</html>
